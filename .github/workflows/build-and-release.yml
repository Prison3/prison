name: Build and Release Android APK

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的 tag 时触发，例如 v1.0.0
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 需要完整的 git 历史来获取 commit count
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Decode keystore file
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        if [ -n "$KEYSTORE_BASE64" ]; then
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
        else
          echo "警告: KEYSTORE_BASE64 secret 未设置，将使用项目中的 keystore 文件（如果存在）"
        fi
    
    - name: Build Release APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # 如果设置了 secrets，则使用环境变量覆盖 build.gradle 中的值
        if [ -n "$KEYSTORE_PASSWORD" ] && [ -n "$KEY_ALIAS" ] && [ -n "$KEY_PASSWORD" ]; then
          echo "使用 GitHub Secrets 中的签名信息"
        fi
        ./gradlew assembleRelease --no-daemon
    
    - name: Find APK files
      id: find_apk
      run: |
        APK_FILES=$(find app/build/outputs/apk -name "*.apk" -type f)
        echo "找到的 APK 文件:"
        echo "$APK_FILES"
        echo "apk_files<<EOF" >> $GITHUB_OUTPUT
        echo "$APK_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Get version info
      id: version_info
      run: |
        # 获取 git commit count 作为 version code
        VERSION_CODE=$(git rev-list --count HEAD || echo "1")
        # 获取 git describe 作为 version name 的一部分
        GIT_DESCRIBE=$(git describe --tags --always || echo "unknown")
        VERSION_NAME="${VERSION_CODE} - ${GIT_DESCRIBE}"
        # 获取 git tag（如果有）
        GIT_TAG=${GITHUB_REF#refs/tags/}
        if [ "$GIT_TAG" = "$GITHUB_REF" ]; then
          GIT_TAG="v${VERSION_CODE}"
        fi
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "git_tag=$GIT_TAG" >> $GITHUB_OUTPUT
        echo "Version Code: $VERSION_CODE"
        echo "Version Name: $VERSION_NAME"
        echo "Release Tag: $GIT_TAG"
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version_info.outputs.git_tag }}
        name: Release ${{ steps.version_info.outputs.version_name }}
        body: |
          ## 版本信息
          - **Version Code**: ${{ steps.version_info.outputs.version_code }}
          - **Version Name**: ${{ steps.version_info.outputs.version_name }}
          - **Build Date**: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          
          ## 下载
          请下载对应架构的 APK 文件：
          - `armeabi-v7a`: 32位 ARM 设备
          - `arm64-v8a`: 64位 ARM 设备
          - `universal`: 通用版本（包含所有架构）
        draft: false
        prerelease: false
        files: |
          app/build/outputs/apk/**/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
